<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raum</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <img src="./pictures/logo.jpg" alt="Logo" width="50" height="50" class="d-inline-block align-text-center">
                Mein Smart-Home Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="roomlist.html">Räume</a></li>
                    <li class="nav-item"><a class="nav-link" href="device.html">Geräte</a></li>
                    <li class="nav-item"><a class="nav-link" href="statistics.html">Statistik</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-3">
        <h1 id="roomName">Raum wird geladen ...</h1>
    </div>

    <div class="container" id="roomContent">
        <!-- Geräte werden hier dynamisch geladen -->
    </div>

    <script>
        const TYPE = {
            STECKDOSE: 1,
            ROLLLADEN: 2,
            LICHT: 3,
            HEIZUNG: 4
        };

        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('id');

        const roomNameEl = document.getElementById('roomName');
        const roomContent = document.getElementById('roomContent');

        function isOn(v) {
            if (typeof v === "number") return v !== 0;
            const s = String(v).toLowerCase();
            return s === "on" || s === "true" || s === "1";
        }

        function blindImgForPercent(pct) {
            if (pct <= 5) return "./pictures/blinds_open.png";
            if (pct >= 95) return "./pictures/blinds_closed.png";
            return "./pictures/blinds_half.png";
        }

        function socketImg(on) {
            return on ? "./pictures/steckdose_on.png" : "./pictures/steckdose_off.png";
        }

        function lightImg(on) {
            return on ? "./pictures/lightbulb_on.png" : "./pictures/lightbulb_off.png";
        }

        function loadRoom() {
            // Raum laden
            fetch(`http://localhost:8000/api/rooms/get/${roomId}`)
                .then(res => res.json())
                .then(room => {
                    roomNameEl.textContent = room.name;
                });

            // Geräte laden
            fetch(`http://localhost:8000/api/rooms/${roomId}/devices`)
                .then(res => res.json())
                .then(devices => renderDevices(devices))
                .catch(err => {
                    roomContent.innerHTML = `<div class="text-danger">Fehler beim Laden der Geräte</div>`;
                    console.error(err);
                });
        }

        function renderDevices(devices) {
            roomContent.innerHTML = '';

            const blinds = devices.filter(d => d.device_type_id === TYPE.ROLLLADEN);
            const temps = devices.filter(d => d.device_type_id === TYPE.HEIZUNG);
            const sockets = devices.filter(d => d.device_type_id === TYPE.STECKDOSE);
            const lights = devices.filter(d => d.device_type_id === TYPE.LICHT);

            // Rollläden
            if (blinds.length) {
                const blindCard = document.createElement('div');
                blindCard.className = 'card my-3 p-2';
                blindCard.innerHTML = `<h5>Rollladensteuerung:</h5>`;
                blinds.forEach(b => {
                    const div = document.createElement('div');
                    div.className = 'mb-2';
                    div.innerHTML = `
                        <label>${b.name}: <output>${b.value}%</output></label>
                        <input type="range" min="0" max="100" value="${b.value}" class="form-range">
                        <img src="${blindImgForPercent(b.value)}" width="100px">
                    `;
                    const range = div.querySelector('input[type=range]');
                    const output = div.querySelector('output');
                    range.addEventListener('input', (e) => {
                        output.textContent = e.target.value + '%';
                        div.querySelector('img').src = blindImgForPercent(Number(e.target.value));
                    });
                    range.addEventListener('change', (e) => {
                        fetch(`http://localhost:8000/api/device/value/${b.device_id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: Number(e.target.value) })
                        });
                    });
                    blindCard.appendChild(div);
                });
                roomContent.appendChild(blindCard);
            }

            // Heizung
            if (temps.length) {
                const t = temps[0];
                const tempCard = document.createElement('div');
                tempCard.className = 'card my-3 p-2';
                tempCard.innerHTML = `
                    <h5>Heizung:</h5>
                    <div class="d-flex align-items-center">
                        <button class="btn btn-secondary" id="minusTemp">-</button>
                        <h2 id="tempDisplay" class="mx-2">${t.value.toFixed(1)}°C</h2>
                        <button class="btn btn-secondary" id="plusTemp">+</button>
                    </div>
                `;
                roomContent.appendChild(tempCard);

                let temp = t.value;
                const tempDisplay = tempCard.querySelector('#tempDisplay');

                function updateTempDisplay() {
                    tempDisplay.textContent = temp.toFixed(1) + '°C';
                }

                tempCard.querySelector('#minusTemp').addEventListener('click', () => {
                    temp -= 0.1;
                    updateTempDisplay();
                    fetch(`http://localhost:8000/api/device/value/${t.device_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: temp })
                    });
                });
                tempCard.querySelector('#plusTemp').addEventListener('click', () => {
                    temp += 0.1;
                    updateTempDisplay();
                    fetch(`http://localhost:8000/api/device/value/${t.device_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: temp })
                    });
                });
            }

            // Steckdosen
            if (sockets.length) {
                const socketCard = document.createElement('div');
                socketCard.className = 'card my-3 p-2';
                socketCard.innerHTML = `<h5>Steckdosen:</h5>`;
                sockets.forEach(s => {
                    const div = document.createElement('div');
                    div.className = 'form-check form-switch mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" ${isOn(s.value) ? 'checked' : ''}>
                        <label class="form-check-label">${s.name}</label>
                    `;
                    const checkbox = div.querySelector('input[type=checkbox]');
                    checkbox.addEventListener('change', (e) => {
                        fetch(`http://localhost:8000/api/device/value/${s.device_id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: e.target.checked ? 1 : 0 })
                        });
                    });
                    socketCard.appendChild(div);
                });
                roomContent.appendChild(socketCard);
            }

            // Licht
            if (lights.length) {
                const lightCard = document.createElement('div');
                lightCard.className = 'card my-3 p-2';
                lightCard.innerHTML = `<h5>Licht:</h5>`;
                lights.forEach(l => {
                    const div = document.createElement('div');
                    div.className = 'form-check form-switch mb-2';
                    div.innerHTML = `
                        <input class="form-check-input" type="checkbox" ${isOn(l.value) ? 'checked' : ''}>
                        <label class="form-check-label">${l.name}</label>
                    `;
                    const checkbox = div.querySelector('input[type=checkbox]');
                    checkbox.addEventListener('change', (e) => {
                        fetch(`http://localhost:8000/api/device/value/${l.device_id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ value: e.target.checked ? 1 : 0 })
                        });
                    });
                    lightCard.appendChild(div);
                });
                roomContent.appendChild(lightCard);
            }
        }

        loadRoom();
    </script>
</body>

</html>
