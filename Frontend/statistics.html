<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistik</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <nav class="navbar bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html">
        <img src="./pictures/logo.jpg" alt="Bootstrap" width="50" height="50" class="d-inline-block align-text-center">
        Mein Smart-Home Dashboard
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="roomlist.html">Räume</a></li>
          <li class="nav-item"><a class="nav-link" href="device.html">Geräte</a></li>
          <li class="nav-item"><a class="nav-link active" href="statistics.html">Statistik</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h1 class="mb-4">Energie-Statistiken</h1>

    <!-- Übersich heute -->
    <div class="row g-4">
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card shadow-sm p-3 rounded-4 text-center">
          <h5 class="card-title">Stromverbrauch</h5>
          <h2 id="kpiConsumption" class="text-primary mb-0">--</h2>
          <small>heute</small>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <div class="card shadow-sm p-3 rounded-4 text-center">
          <h5 class="card-title">Solarertrag</h5>
          <h2 id="kpiGeneration" class="text-success mb-0">--</h2>
          <small>heute</small>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-4">
        <div class="card shadow-sm p-3 rounded-4 text-center">
          <h5 class="card-title">Bilanz</h5>
          <h2 id="kpiBalance" class="text-success mb-0">--</h2>
          <small>Überschuss</small>
        </div>
      </div>
    </div>

    <!-- Card 1: Verbrauch vs. Ertrag (Woche, Monat, Jahr)) -->
    <div class="card shadow-sm p-4 rounded-4 mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h3 class="card-title mb-0">Verbrauch vs. Ertrag</h3>
        <div class="dropdown mt-2 mt-md-0">
          <button id="dropdownTime" class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            Zeitraum auswählen
          </button>
          <ul class="dropdown-menu" aria-labelledby="dropdownTime">
            <li><a class="dropdown-item" href="#" data-range="week">Woche</a></li>
            <li><a class="dropdown-item" href="#" data-range="month">Monat</a></li>
            <li><a class="dropdown-item" href="#" data-range="year">Jahr</a></li>
          </ul>
        </div>
      </div>
      <canvas id="chartEnergy" height="400"></canvas>
    </div>

    <!-- Card 2 Verbrauch Steckdose 7 Tage -->
    <div class="card shadow-sm p-4 rounded-4 mt-4">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h3 class="card-title mb-0">Verbrauch pro Steckdose (7 Tage)</h3>
        <div class="dropdown mt-2 mt-md-0">
          <button id="dropdownOutlet" class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
            aria-expanded="false">
            Steckdose auswählen
          </button>
          <ul class="dropdown-menu" id="outletDropdownMenu" aria-labelledby="dropdownOutlet">
            <!-- JS füllt das dynamisch -->
          </ul>
        </div>
      </div>
      <canvas id="chartOutlet" height="400"></canvas>
    </div>
  </div>
</body>

</html>


<script>
  const API_BASE = 'http://localhost:8000/api';

  // ---------- Chart-Variablen ----------
  let energyChart = null;
  let outletChart = null;

  // Dropdown-Label (für alle Dropdowns)
  document.addEventListener('click', (ev) => {
    if (ev.target.classList.contains('dropdown-item')) {
      const btn = ev.target.closest('.dropdown').querySelector('.dropdown-toggle');
      if (btn) {
        btn.textContent = ev.target.textContent;
      }
    }
  });

  async function loadTodayValues() {
    try {
      const res = await fetch(`${API_BASE}/energy/today`);
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const json = await res.json();
      if (json.error || !json.data) throw new Error(json.message || 'No data');

      const { consumption, generation, balance } = json.data;

      document.getElementById('kpiConsumption').textContent = consumption.toFixed(2) + " kWh";
      document.getElementById('kpiGeneration').textContent = generation.toFixed(2) + " kWh";

      const balanceEl = document.getElementById('kpiBalance');
      balanceEl.textContent = (balance >= 0 ? "+" : "") + balance.toFixed(2) + " kWh";

      // Farbe dynamisch setzen
      balanceEl.classList.remove('text-success', 'text-danger');
      balanceEl.classList.add(balance >= 0 ? 'text-success' : 'text-danger');

    } catch (err) {
      console.error("Fehler beim Laden der KPI-Werte:", err);
    }
  }


  // ---------- OBERER CHART: Verbrauch vs. Ertrag (aus Backend) ----------
  async function loadEnergySummary(range = 'week') {
    try {
      const res = await fetch(`${API_BASE}/energy/summary/${range}`);
      if (!res.ok) throw new Error('HTTP ' + res.status);

      const json = await res.json();
      if (json.error || !json.data) throw new Error(json.message || 'No data');

      const { labels, consumption, generation } = json.data;
      const ctxEnergy = document.getElementById('chartEnergy');

      if (!energyChart) {
        energyChart = new Chart(ctxEnergy, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Verbrauch (kWh)',
                data: consumption,
                borderColor: '#0d6efd',
                tension: 0.3
              },
              {
                label: 'Solarertrag (kWh)',
                data: generation,
                borderColor: '#198754',
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            interaction: { mode: 'index', intersect: false }
          }
        });
      } else {
        energyChart.data.labels = labels;
        energyChart.data.datasets[0].data = consumption;
        energyChart.data.datasets[1].data = generation;
        energyChart.update();
      }
    } catch (err) {
      console.error('Fehler beim Laden der Energie-Statistik:', err);
    }
  }





  // Zeitraum-Dropdown (UI, Backend noch immer nur "week")
  document.querySelectorAll('#dropdownTime + .dropdown-menu .dropdown-item')
    .forEach(a => a.addEventListener('click', () => {
      const range = a.dataset.range || 'week';
      loadEnergySummary(range);
    }));

  // ---------- UNTERER CHART: Steckdosen dynamisch ----------

  async function loadOutletDevices() {
    try {
      const res = await fetch(`${API_BASE}/energy/devices`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if (json.error || !json.data) throw new Error(json.message || 'No data');

      const devices = json.data; // [{device_id, name}, ...]
      const menu = document.getElementById('outletDropdownMenu');
      const btn = document.getElementById('dropdownOutlet');

      menu.innerHTML = '';

      devices.forEach((dev, index) => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.className = 'dropdown-item';
        a.href = '#';
        a.textContent = dev.name;
        a.dataset.deviceId = dev.device_id;
        li.appendChild(a);
        menu.appendChild(li);

        a.addEventListener('click', (ev) => {
          ev.preventDefault();
          btn.textContent = dev.name;
          loadOutletEnergy(dev.device_id);
        });

        // beim ersten Gerät direkt laden
        if (index === 0) {
          btn.textContent = dev.name;
          loadOutletEnergy(dev.device_id);
        }
      });

    } catch (err) {
      console.error('Fehler beim Laden der Outlet-Geräte:', err);
    }
  }

  async function loadOutletEnergy(deviceId) {
    try {
      const res = await fetch(`${API_BASE}/energy/device/${deviceId}/week`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if (json.error || !json.data) throw new Error(json.message || 'No data');

      const { labels, consumption, generation } = json.data;
      const ctxOutlet = document.getElementById('chartOutlet');

      if (!outletChart) {
        outletChart = new Chart(ctxOutlet, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: 'Verbrauch (kWh)',
                data: consumption,
                borderColor: '#0d6efd',
                tension: 0.3
              },
              {
                label: 'Solarertrag (kWh)',
                data: generation,
                borderColor: '#198754',
                tension: 0.3
              }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } },
            interaction: { mode: 'index', intersect: false },
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: 'kWh pro Tag' }
              }
            }
          }
        });
      } else {
        outletChart.data.labels = labels;
        outletChart.data.datasets[0].data = consumption;
        outletChart.data.datasets[1].data = generation;
        outletChart.update();
      }
    } catch (err) {
      console.error('Fehler beim Laden der Steckdosen-Statistik:', err);
    }
  }

  // ---------- Initial-Load ----------
  document.addEventListener('DOMContentLoaded', () => {
    loadTodayValues();
    loadEnergySummary('week');
    loadOutletDevices();
  });

</script>