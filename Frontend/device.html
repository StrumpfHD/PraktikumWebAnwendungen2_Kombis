<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geräteanzeige</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <img src="./pictures/logo.jpg" alt="Bootstrap" width="50" height="50"
                    class="d-inline-block align-text-center">
                Mein Smart-Home Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="dashboard.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="roomlist.html">Räume</a></li>
                    <li class="nav-item"><a class="nav-link active" href="device.html">Geräte</a></li>
                    <li class="nav-item"><a class="nav-link" href="statistics.html">Statistik</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h1>Geräteliste</h1>

        <table class="table table-striped align-middle">
            <thead>
                <tr>
                    <th style="width: 5%;"></th>
                    <th style="width: 35%;">Name</th>
                    <th style="width: 25%;">Zimmer</th>
                    <th style="width: 25%;">Zustand</th>
                    <th style="width: 10%;"></th>
                </tr>
            </thead>
            <tbody id="deviceTableBody">
                <!-- Dynamischer Inhalt -> Geräte -->
            </tbody>
        </table>

        <button class="btn btn-primary mt-3" id="openAddDeviceBtn">
            <i class="bi bi-plus-circle"></i> Gerät hinzufügen
        </button>
    </div>

    <div id="modalContainerDevice"></div>

    <script>
        $(document).ready(function () {

            const deviceTableBody = $("#deviceTableBody");

            const API_ROOMS = "http://localhost:8000/api/rooms/all";
            const API_DEVICE_TYPES = "http://localhost:8000/api/device_type/all";
            const API_DEVICES = "http://localhost:8000/api/device/all";

            let rooms = [];
            let deviceTypes = [];

            // -----------------------------
            // Mapping Gerätetyp -> Icon
            // -----------------------------
            const typeIcons = {
                "Licht": "bi-lightbulb",
                "Heizung": "bi-thermometer-half",
                "Steckdose": "bi-plug-fill",
                "Rollladen": "bi-cloud-moon",
                // weitere Typen hier ergänzen
            };

            // -----------------------------
            // Räume + Gerätetypen laden
            // -----------------------------
            function preloadData() {
                const req1 = $.ajax({ url: API_ROOMS, method: "GET", dataType: "json" });
                const req2 = $.ajax({ url: API_DEVICE_TYPES, method: "GET", dataType: "json" });

                return $.when(req1, req2).done((roomsRes, typesRes) => {
                    rooms = roomsRes[0];
                    deviceTypes = typesRes[0];
                });
            }

            function getRoomName(id) {
                const r = rooms.find(x => x.room_id == id);
                return r ? r.name : "Unbekannt";
            }

            function getDeviceTypeName(id) {
                const t = deviceTypes.find(x => x.device_type_id == id);
                return t ? t.name : "Unbekannt";
            }

            function getDeviceIcon(typeName) {
                return typeIcons[typeName] || "bi-question-circle";
            }

            // -----------------------------
            // Zustand formatieren nach Gerätetyp
            // -----------------------------
            function formatDeviceState(device) {
                const typeName = getDeviceTypeName(device.device_type_id);
                switch (typeName) {
                    case "Licht":
                    case "Steckdose":
                        return device.value ? "<span class='badge bg-success'>AN</span>" : "<span class='badge bg-secondary'>AUS</span>";
                    case "Heizung":
                        return `<span class="badge bg-info">${device.value.toFixed(1)}°C</span>`;
                    case "Rollladen":
                        return `<span class="badge bg-warning">${device.value}%</span>`;
                    default:
                        return device.value ? `<span class='badge bg-success'>${device.value}</span>` : "<span class='badge bg-secondary'>Unbekannt</span>";
                }
            }

            // -----------------------------
            // Geräte laden & nach Typ gruppieren
            // -----------------------------
            function loadDevices() {
                preloadData().then(() => {
                    $.ajax({
                        url: API_DEVICES,
                        method: "GET",
                        dataType: "json",
                        cache: false
                    }).done(function (devices) {

                        deviceTableBody.empty();

                        // Geräte nach Typ gruppieren
                        const devicesByType = {};
                        devices.forEach(d => {
                            const typeName = getDeviceTypeName(d.device_type_id);
                            if (!devicesByType[typeName]) devicesByType[typeName] = [];
                            devicesByType[typeName].push(d);
                        });

                        // Jede Gruppe als Unterüberschrift + Geräte einfügen
                        Object.keys(devicesByType).forEach(typeName => {
                            const iconClass = getDeviceIcon(typeName);

                            // Gruppenüberschrift
                            const groupHeader = `
                            <tr class="table-primary">
                                <td colspan="5">
                                    <i class="bi ${iconClass} me-2"></i>
                                    <strong>${typeName}</strong>
                                </td>
                            </tr>
                        `;
                            deviceTableBody.append(groupHeader);

                            // Geräte dieser Gruppe
                            devicesByType[typeName].forEach(device => {
                                const stateBadge = formatDeviceState(device);

                                const row = `
                                <tr>
                                    <td><i class="bi ${iconClass} fs-4"></i></td>
                                    <td><strong>${device.name}</strong></td>
                                    <td>${getRoomName(device.room_id)}</td>
                                    <td>${stateBadge}</td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-primary edit-device-btn" data-id="${device.device_id}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-device-btn" data-id="${device.device_id}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                                deviceTableBody.append(row);
                            });
                        });

                    }).fail(function (xhr) {
                        console.error("Fehler beim Laden der Geräte:", xhr.responseText);
                        alert("Fehler beim Laden der Geräte!");
                    });
                });
            }

            // -----------------------------
            // Edit & Delete Buttons
            // -----------------------------
            $(document).on("click", ".edit-device-btn", function () {
                const id = $(this).data("id");
                alert("Gerät bearbeiten: " + id);
            });

            $(document).on("click", ".delete-device-btn", function () {
                const id = $(this).data("id");
                alert("Gerät löschen: " + id);
            });

            // Initial laden
            loadDevices();

        });
    </script>
</body>

</html>