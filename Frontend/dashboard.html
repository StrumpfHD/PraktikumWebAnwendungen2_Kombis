<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <script src="js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="dashboard.html">
                <img src="./pictures/logo.jpg" alt="Bootstrap" width="50" height="50"
                    class="d-inline-block align-text-center">
                Mein Smart-Home Dashboard
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link active" href="dashboard.html">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="roomlist.html">Räume</a></li>
                    <li class="nav-item"><a class="nav-link" href="device.html">Geräte</a></li>
                    <li class="nav-item"><a class="nav-link" href="statistics.html">Statistik</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <h1>Hallo Benutzer!</h1> <button type="button" class="btn btn-danger"
            onclick="alert('Alarm wurde gedrückt! ALAAAAAAAARM!');">Alarm auslösen!</button>
    </div>

    <div class="container mt-4">
        <div id="roomsRow" class="row g-4"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function () {

            // -----------------------------
            // Konstanten / Typen (device_type_id)
            // -----------------------------
            const TYPE = {
                STECKDOSE: 1,
                ROLLLADEN: 2,
                LICHT: 3,
                HEIZUNG: 4
                // 5 = Verbrauch (optional)
            };

            // -----------------------------
            // Icons / Werte
            // -----------------------------
            function blindImgForPercent(pct) {
                const n = Number(pct);
                if (!Number.isFinite(n)) return "./pictures/blinds_half.png";
                if (n <= 25) return "./pictures/blinds_open.png";
                if (n >= 75) return "./pictures/blinds_closed.png";
                return "./pictures/blinds_half.png";
            }

            function isOn(v) {
                if (typeof v === "number") return v !== 0;
                const s = String(v).toLowerCase();
                return s === "on" || s === "true" || s === "1";
            }

            function socketImg(on) {
                return on ? "./pictures/steckdose_on.png" : "./pictures/steckdose_off.png";
            }

            function lightImg(on) {
                return on ? "./pictures/lightbulb_on.png" : "./pictures/lightbulb_off.png";
            }

            // -----------------------------
            // Dashboard laden
            // -----------------------------
            function loadRooms() {
                const row = $("#roomsRow");
                row.empty();

                $.ajax({
                    url: "http://localhost:8000/api/rooms/all",
                    method: "GET",
                    dataType: "json",
                    cache: false
                }).done(function (rooms) {

                    rooms.forEach(room => {

                        // Card-Template (Platzhalter)
                        const card = $(`
                    <div class="col-12 col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">

                        <h3 class="card-title">
                            <a href="room.html?id=${room.room_id}" class="text-decoration-none text-dark">
                            ${room.name} (Status)
                            </a>
                        </h3>

                        <h6 class="card-text m-3 text-center"><u>Rollladen-Status:</u></h6>
                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-3 js-blinds">
                            <div class="text-muted">Lade...</div>
                        </div>

                        <h6 class="card-text m-3 text-center"><u>Aktuelle Temperatur:</u></h6>
                        <div class="card">
                            <div class="d-flex justify-content-center align-items-center m-1">
                            <h2 class="mb-0 mx-2 js-temp">—</h2>
                            </div>
                        </div>

                        <h6 class="card-text m-3 text-center"><u>Steckdosen-Status:</u></h6>
                        <div class="d-flex justify-content-center align-items-center flex-wrap gap-3 js-sockets">
                            <div class="text-muted">Lade...</div>
                        </div>

                        <h6 class="card-text m-3 text-center"><u>Licht-Status:</u></h6>
                        <div class="d-flex justify-content-center align-items-stretch flex-wrap gap-3 js-lights">
                            <div class="text-muted">Lade...</div>
                        </div>

                        </div>

                        <div class="card-footer text-center">
                            <a href="room.html?id=${room.room_id}" class="btn btn-primary w-100 mb-2">
                                <i class="bi bi-door-open"></i> Raum anzeigen
                            </a>

                            <a href="roomlist.html" class="btn btn-sm btn-outline-secondary w-100">
                                <i class="bi bi-sliders"></i> Raum bearbeiten
                            </a>
                        </div>

                    </div>
                    </div>
                `);

                        row.append(card);

                        // Geräte für diesen Raum laden
                        $.ajax({
                            url: `http://localhost:8000/api/rooms/${room.room_id}/devices`,
                            method: "GET",
                            dataType: "json"
                        }).done(function (devices) {

                            const blinds = devices.filter(d => d.device_type_id === TYPE.ROLLLADEN).slice(0, 2);
                            const temps = devices.filter(d => d.device_type_id === TYPE.HEIZUNG);
                            const sockets = devices.filter(d => d.device_type_id === TYPE.STECKDOSE).slice(0, 2);
                            const lights = devices.filter(d => d.device_type_id === TYPE.LICHT).slice(0, 2);

                            // Rollläden
                            const blindsBox = card.find(".js-blinds");
                            blindsBox.empty();
                            if (blinds.length === 0) {
                                blindsBox.html(`<div class="text-muted text-center">Keine Rollläden</div>`);
                            } else {
                                blinds.forEach(b => {
                                    blindsBox.append(`
                        <div class="card" style="width: 47%;">
                            <div class="card-body text-center">
                            <p>${b.name}</p>
                            <img class="img-fluid" src="${blindImgForPercent(b.value)}" width="100px">
                            <h3>${b.value}%</h3>
                            </div>
                        </div>
                        `);
                                });
                            }

                            // Temperatur (Heizung)
                            const tempEl = card.find(".js-temp");
                            tempEl.text(
                                temps[0] ? `${Number(temps[0].value).toFixed(1)}°C` : "—"
                            );

                            // Steckdosen
                            const socketsBox = card.find(".js-sockets");
                            socketsBox.empty();
                            if (sockets.length === 0) {
                                socketsBox.html(`<div class="text-muted text-center">Keine Steckdosen</div>`);
                            } else {
                                sockets.forEach(s => {
                                    const on = isOn(s.value);
                                    socketsBox.append(`
                        <div class="card" style="width: 47%;">
                            <div class="card-body text-center">
                            <p>${s.name}</p>
                            <img class="img-fluid" src="${socketImg(on)}" width="70px">
                            <h3>${on ? "On" : "Off"}</h3>
                            </div>
                        </div>
                        `);
                                });
                            }

                            // Lichter
                            const lightsBox = card.find(".js-lights");
                            lightsBox.empty();
                            if (lights.length === 0) {
                                lightsBox.html(`<div class="text-muted text-center">Keine Lichter</div>`);
                            } else {
                                lights.forEach(l => {
                                    const on = isOn(l.value);
                                    lightsBox.append(`
                        <div class="card" style="width: 47%;">
                            <div class="card-title text-center m-2">${l.name}</div>
                            <div class="card-body text-center">
                            <img class="img-fluid" src="${lightImg(on)}" width="70px">
                            <h3>${on ? "On" : "Off"}</h3>
                            </div>
                        </div>
                        `);
                                });
                            }

                        }).fail(function () {
                            card.find(".js-blinds").html(`<div class="text-muted text-center">Fehler</div>`);
                            card.find(".js-temp").text("—");
                            card.find(".js-sockets").html(`<div class="text-muted text-center">Fehler</div>`);
                            card.find(".js-lights").html(`<div class="text-muted text-center">Fehler</div>`);
                        });

                    });

                }).fail(function (jqXHR) {
                    console.error("Fehler beim Laden der Räume:", jqXHR.responseText);
                    alert("Fehler beim Laden der Räume!");
                });
            }

            // Initial laden
            loadRooms();
        });
    </script>


</body>

</html>